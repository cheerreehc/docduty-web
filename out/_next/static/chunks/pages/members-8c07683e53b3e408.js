(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[265],{150:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>g});var a=r(7876),s=r(4232),o=r(9744);async function n(){let e=(0,o.S)(!0),{data:t,error:r}=await e.auth.getUser(),a=null==t?void 0:t.user;if(!a)return void console.warn("ยังไม่ได้ login");let{data:s,error:n}=await e.from("members").select("id").eq("user_id",a.id).maybeSingle();if(n)return void console.error("ตรวจสอบสมาชิกล้มเหลว",n);if(s)return void console.log("ผู้ใช้มี workspace แล้ว ไม่ต้องสร้างใหม่");let{data:i,error:l}=await e.from("workspaces").insert({name:"".concat(a.email,"'s Workspace")}).select().single();if(l||!i)return void console.error("สร้าง workspace ไม่สำเร็จ",l);let{error:c}=await e.from("members").insert({user_id:a.id,email:a.email,workspace_id:i.id,role:"owner"});if(c)return void console.error("เพิ่มสมาชิกไม่สำเร็จ",c);console.log("✅ สร้าง workspace และสมาชิก owner สำเร็จ"),location.reload()}var i=r(9688),l=r(2491),c=r.n(l),u=r(7002),d=r.n(u),m=r(3679);function p(e){let{workspace:t,updateWorkspaceName:r}=e,[o,n]=(0,s.useState)(!1),[i,l]=(0,s.useState)(t),c=()=>{i.trim()!==t&&r(i.trim()),n(!1)};return(0,a.jsxs)("div",{className:"mb-6 text-gray-500",children:["Workspace:"," ",o?(0,a.jsxs)("span",{className:"inline-flex items-center gap-2",children:[(0,a.jsx)("input",{className:"border-b border-gray-400 bg-transparent focus:outline-none text-gray-800 font-semibold",value:i,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"===e.key&&c(),"Escape"===e.key&&n(!1)},autoFocus:!0}),(0,a.jsx)("button",{className:"text-sm text-teal-600",onClick:c,children:"บันทึก"}),(0,a.jsx)("button",{className:"text-sm text-gray-400",onClick:()=>{n(!1),l(t)},children:"ยกเลิก"})]}):(0,a.jsxs)("span",{className:"font-semibold text-gray-800 inline-flex items-center gap-2",children:[t||"ไม่พบ",(0,a.jsx)(m.F7,{className:"text-xs cursor-pointer text-gray-400 hover:text-teal-600",onClick:()=>n(!0)})]})]})}let f=d()(c());function g(){let[e,t]=(0,s.useState)(null),[r,l]=(0,s.useState)([]),[c,u]=(0,s.useState)(""),d=c.trim().toLowerCase(),m=(0,o.S)(!0),[g,h]=(0,s.useState)(null),[b,v]=(0,s.useState)(!1),[w,x]=(0,s.useState)(null);(0,s.useEffect)(()=>{n(),m.auth.getUser().then(e=>{var t;let{data:r}=e;h((null==(t=r.user)?void 0:t.id)||null)}),y()},[]);let y=async()=>{var e,a,s;let o=r.find(e=>e.user_id===g);x((null==o?void 0:o.role)||null),v(!0);let{data:n}=await m.auth.getUser(),{data:i}=await m.from("members").select("*, workspaces(name)").eq("user_id",null==n||null==(e=n.user)?void 0:e.id).single();if(!i||!(null==n||null==(a=n.user)?void 0:a.id))return;t((null==(s=i.workspaces)?void 0:s.name)||"ไม่พบ");let{data:c}=await m.from("members").select("*").eq("workspace_id",i.workspace_id).eq("status","active").order("created_at",{ascending:!0});console.log("All members:",c),console.log("workspace_id:",i.workspace_id),l(c||[]),v(!1)},j=async()=>{var e;let{data:t}=await m.auth.getUser(),r=null==t||null==(e=t.user)?void 0:e.id;if(console.log("\uD83D\uDD10 myID : ",r),!r)return;let{data:a}=await m.from("members").select("*").eq("user_id",r).single();if(console.log("\uD83D\uDD10 myMember : ",a),!a)return;let{data:s}=await m.from("members").select("*").eq("email",d).eq("workspace_id",a.workspace_id).eq("status","active").maybeSingle();if(s)return void i.oR.error("อีเมลนี้เป็นสมาชิกอยู่แล้ว");let{data:o}=await m.from("members").select("*").eq("email",c).eq("workspace_id",a.workspace_id).eq("status","removed").maybeSingle();if(o)await m.from("members").update({status:"active",role:"viewer"}).eq("id",o.id);else{let{error:e}=await m.from("members").insert({email:d,workspace_id:a.workspace_id,role:"viewer",status:"active"});if(e)return void("23505"===e.code?i.oR.error("อีเมลนี้เป็นสมาชิกใน workspace นี้อยู่แล้ว"):i.oR.error("เกิดข้อผิดพลาด: "+e.message))}f.fire({toast:!0,position:"top-end",icon:"success",title:"ส่งคำเชิญสำเร็จ",showConfirmButton:!1,timer:2e3,timerProgressBar:!0}),u(""),y()},k=async e=>{var t;if(!await f.fire({title:"ลบสมาชิกคนนี้?",text:"คุณแน่ใจว่าต้องการลบสมาชิกคนนี้ออกจาก workspace?\nเมื่อลบแล้วสามารถเชิญอีเมลนี้ใหม่ได้ภายหลัง",icon:"warning",showCancelButton:!0,confirmButtonText:"ลบเลย",cancelButtonText:"ยกเลิก",confirmButtonColor:"#d33",reverseButtons:!0}).then(e=>e.isConfirmed))return;let{data:r}=await m.auth.getUser(),a=null==r||null==(t=r.user)?void 0:t.id;if(!a)return;let{data:s}=await m.from("members").select("*").eq("user_id",a).single();if(!s||"owner"!==s.role)return void f.fire("ไม่มีสิทธิ์ลบ","","error");if(s.id===e)return void f.fire("ไม่สามารถลบตัวเองได้","","error");let{error:o}=await m.from("members").update({status:"removed",removed_at:new Date().toISOString()}).eq("id",e).eq("workspace_id",s.workspace_id);console.log("workspace ID ที่ใช้ลบ:",s.workspace_id),console.log("\uD83E\uDDEA ลบแล้ว:",e,o),o?f.fire("เกิดข้อผิดพลาด",o.message,"error"):(i.oR.success("ลบสมาชิกแล้ว"),y())},_=async(e,t)=>{let{error:r}=await m.from("members").update({year_level:t}).eq("id",e);r?i.oR.error("อัปเดตชั้นปีไม่สำเร็จ"):(i.oR.success("อัปเดตชั้นปีเรียบร้อย"),y())},N=async e=>{var r,a,s;let{data:o}=await m.auth.getUser(),n=null==o||null==(r=o.user)?void 0:r.id;if(!n)return;let{data:l}=await m.from("members").select("*").eq("user_id",n).eq("role","owner").single();if(!l)return void i.oR.error("คุณไม่มีสิทธิ์แก้ไขชื่อ workspace");if(!e.trim())return void i.oR.error("กรุณาใส่ชื่อใหม่");let{data:c,error:u}=await m.from("workspaces").update({name:e}).eq("id",l.workspace_id).select();u?console.error("❌ update error:",u):console.log("✅ update สำเร็จ:",c),u||t(null!=(s=null==c||null==(a=c[0])?void 0:a.name)?s:e),console.log("\uD83E\uDDEA อัปเดตชื่อ workspace:",e),console.log("\uD83D\uDCE6 workspace ID:",l.workspace_id)};return(0,a.jsxs)("div",{className:"p-6 max-w-3xl mx-auto",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold font-round mb-2",children:"จัดการสมาชิก"}),(0,a.jsx)(p,{workspace:e||"",updateWorkspaceName:N}),(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow p-4 mb-6 space-y-4",children:[(0,a.jsx)("label",{className:"font-semibold block",children:"เชิญหมอด้วย Email"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"email",value:c,onChange:e=>u(e.target.value),placeholder:"doctor@example.com",className:"border border-gray-300 rounded-md px-3 py-2 flex-1 focus:outline-none focus:ring-2 focus:ring-[#008191]"}),(0,a.jsx)("button",{disabled:b,onClick:j,className:"px-4 py-2 rounded-md text-white font-semibold transition ".concat(b?"bg-gray-400 cursor-not-allowed":"bg-[#008191] hover:bg-[#015A66]"),children:b?"กำลังเชิญ...":"เชิญ"})]})]}),(0,a.jsxs)("table",{className:"w-full text-sm text-left border shadow rounded-md overflow-hidden",children:[(0,a.jsx)("thead",{className:"bg-[#f0fafa] text-gray-700 font-medium",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-3",children:"Email"}),(0,a.jsx)("th",{className:"p-3",children:"Year"}),(0,a.jsx)("th",{className:"p-3",children:"Role"}),(0,a.jsx)("th",{className:"p-3",children:"สถานะ"}),(0,a.jsx)("th",{className:"p-3 text-center",children:"ลบ"})]})}),(0,a.jsx)("tbody",{className:"divide-y",children:r.map(e=>(0,a.jsxs)("tr",{className:"hover:bg-[#f8fafa]",children:[(0,a.jsx)("td",{className:"p-3",children:e.email||"ยังไม่ตอบรับ"}),(0,a.jsx)("td",{className:"p-2",children:void 0!==w?(0,a.jsxs)("select",{className:"text-sm border rounded p-1",value:e.year_level||"",onChange:t=>_(e.id,t.target.value),children:[(0,a.jsx)("option",{value:"",children:"—"}),(0,a.jsx)("option",{value:"Extern",children:"Extern"}),(0,a.jsx)("option",{value:"Intern",children:"Intern"}),(0,a.jsx)("option",{value:"R1",children:"R1"}),(0,a.jsx)("option",{value:"R2",children:"R2"}),(0,a.jsx)("option",{value:"R3",children:"R3"}),(0,a.jsx)("option",{value:"Staff",children:"Staff"})]}):e.year_level||"—"}),(0,a.jsx)("td",{className:"p-3 capitalize",children:e.role}),(0,a.jsx)("td",{className:"p-3",children:(0,a.jsx)("span",{className:"px-3 py-1 rounded-full text-xs font-medium \n                  ".concat("removed"===e.status?"bg-red-100 text-red-700":e.user_id?"bg-green-100 text-green-700":e.email?"bg-yellow-100 text-yellow-800":"bg-gray-200 text-gray-600"),children:"removed"===e.status?"ถูกลบ":e.user_id?"สมาชิก":e.email?"รอตอบรับ":"—"})}),(0,a.jsx)("td",{className:"p-3 text-center",children:e.user_id===g?(0,a.jsx)("span",{className:"text-gray-400",children:"—"}):(0,a.jsx)("button",{onClick:()=>k(e.id),className:"text-red-500 hover:underline text-sm",children:"ลบ"})})]},e.id))})]})]})}},864:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/members",function(){return r(150)}])},3620:(e,t,r)=>{"use strict";r.d(t,{k5:()=>u});var a=r(4232),s={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},o=a.createContext&&a.createContext(s),n=["attr","size","title"];function i(){return(i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,a)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach(function(t){var a,s,o;a=e,s=t,o=r[t],(s=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var a=r.call(e,t||"default");if("object"!=typeof a)return a;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(s))in a?Object.defineProperty(a,s,{value:o,enumerable:!0,configurable:!0,writable:!0}):a[s]=o}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e){return t=>a.createElement(d,i({attr:c({},e.attr)},t),function e(t){return t&&t.map((t,r)=>a.createElement(t.tag,c({key:r},t.attr),e(t.child)))}(e.child))}function d(e){var t=t=>{var r,{attr:s,size:o,title:l}=e,u=function(e,t){if(null==e)return{};var r,a,s=function(e,t){if(null==e)return{};var r={};for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){if(t.indexOf(a)>=0)continue;r[a]=e[a]}return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],!(t.indexOf(r)>=0)&&Object.prototype.propertyIsEnumerable.call(e,r)&&(s[r]=e[r])}return s}(e,n),d=o||t.size||"1em";return t.className&&(r=t.className),e.className&&(r=(r?r+" ":"")+e.className),a.createElement("svg",i({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},t.attr,s,u,{className:r,style:c(c({color:e.color||t.color},t.style),e.style),height:d,width:d,xmlns:"http://www.w3.org/2000/svg"}),l&&a.createElement("title",null,l),e.children)};return void 0!==o?a.createElement(o.Consumer,null,e=>t(e)):t(s)}},7002:function(e,t,r){e.exports=function(e,t){"use strict";let r=[{key:"title",getter:e=>e.getTitle()},{key:"html",getter:e=>e.getHtmlContainer()},{key:"confirmButtonText",getter:e=>e.getConfirmButton()},{key:"denyButtonText",getter:e=>e.getDenyButton()},{key:"cancelButtonText",getter:e=>e.getCancelButton()},{key:"footer",getter:e=>e.getFooter()},{key:"closeButtonHtml",getter:e=>e.getCloseButton()},{key:"iconHtml",getter:e=>e.getIconContent()},{key:"loaderHtml",getter:e=>e.getLoader()}],a=()=>{};return function(s){function o(t){let a={},s={},o=r.map(e=>e.key);return Object.entries(t).forEach(t=>{let[r,n]=t;o.includes(r)&&e.isValidElement(n)?(a[r]=n,s[r]=" "):s[r]=n}),[a,s]}function n(e,a){Object.entries(a).forEach(a=>{let[o,n]=a,i=r.find(e=>e.key===o).getter(s),l=t.createRoot(i);l.render(n),e.__roots.push(l)})}function i(e){e.__roots.forEach(e=>{e.unmount()}),e.__roots=[]}return class extends s{static argsToParams(t){if(!(e.isValidElement(t[0])||e.isValidElement(t[1])))return s.argsToParams(t);{let e={};return["title","html","icon"].forEach((r,a)=>{void 0!==t[a]&&(e[r]=t[a])}),e}}_main(e,t){this.__roots=[],this.__params=Object.assign({},t,e);let[r,s]=o(this.__params),l=s.willOpen||a,c=s.didOpen||a,u=s.didDestroy||a;return super._main(Object.assign({},s,{willOpen:e=>{n(this,r),l(e)},didOpen:e=>{setTimeout(()=>{c(e)})},didDestroy:e=>{u(e),i(this)}}))}update(e){Object.assign(this.__params,e),i(this);let[t,r]=o(this.__params);super.update(r),n(this,t)}}}}(r(4232),r(8944))},9744:(e,t,r)=>{"use strict";r.d(t,{S:()=>s});var a=r(7155);function s(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return(0,a.createBrowserClient)("https://pqnmfikncumnshlbgsmz.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbm1maWtuY3VtbnNobGJnc216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3OTA1MjcsImV4cCI6MjA2NzM2NjUyN30.OkQGTUr6SbEp6AfrtF49zNkBb1uK9FKtwCuRRnnw-HA",{auth:{storage:e?localStorage:sessionStorage,persistSession:!0,autoRefreshToken:!0}})}}},e=>{var t=t=>e(e.s=t);e.O(0,[938,390,155,636,593,792],()=>t(864)),_N_E=e.O()}]);